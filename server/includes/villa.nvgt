#include "bgt_compat.nvgt"#include "bgt_compat.nvgt"villa@[] villas(0);
class villa {
	int x, y, z, code, health, hackmode = -1, hacktime, canbell = 0, security_boosts = 0;
	string id, map, villamap, owner, hitby = "nothing", hacker = "noone", bellsound, itemdeleted = "villa";
	bool hacking = false;
	timer hacktimer;
	savedata tempsd("");
	villa(int vx, int vy, int vz, string vmap, string vowner, int vcode, int vhealth, string vvillamap, string vitemdeleted, string vid = "") {
		x = vx;
		y = vy;
		z = vz;
		map = vmap;
		owner = vowner;
		code = vcode;
		health = vhealth;
		villamap = vvillamap;
		itemdeleted = vitemdeleted;
		id = vid;
		tempsd.fn = "villas/" + id + ".villa";
		tempsd.key = "dl_villa";
	}
	void villaplay(string soundfile) {
		send_packet(6, "play locker_" + soundfile + ".ogg " + x + " " + y + " " + z, x, y, z, maps[get_map_index(map)]);
	}
	void villa_save() {
		if (directory_exists("villas") == false)
			directory_create("villas");
		tempsd.add("x", x);
		tempsd.add("y", y);
		tempsd.add("z", z);
		tempsd.add("map", map);
		tempsd.add("owner", owner);
		tempsd.add("code", code);
		tempsd.add("health", health);
		tempsd.add("villamap", villamap);
		tempsd.add("security_boosts", security_boosts);
		tempsd.add("bellsound", bellsound);
		tempsd.add("canbell", canbell);
		tempsd.add("id", id);
		tempsd.add("itemdeleted", itemdeleted);
		tempsd.save();
	}
	void loop(int i) {
		if (health <= 0) {
			send_packet(6, "play base_dest.ogg " + x + " " + y + " " + z, x, y, z, maps[get_map_index(map)]);
			send_dpacket(6, "distsound base_destdist " + x + " " + y + " " + z + " " + map, maps[get_map_index(map)]);
			for (uint i2 = 0; i2 < players.length(); i2++) {
				if (players[i2].map == villamap) {
					move_player(players[i2], map, x, y, z);
					send_reliable(players[i2], "exitplace", 0);
					players[i2].health -= 50000;
				}
			}
			for (uint i2 = 0; i2 < msounds.length(); i2++) {
				if (msounds[i2].map == villamap) {
					msounds.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < ais.length(); i2++) {
				if (ais[i2].map.name == villamap) {
					if (ais[i2].voice != "" and ais[i2].rapidvoice == true) destroy_moving_sound(ais[i2].voice);
					ais.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < beehives.length(); i2++) {
				if (beehives[i2].map == villamap) {
					file_delete("beehives/" + beehives[i2].beehivemap + ".beehive");
					remove_map(beehives[i2].beehivemap);
					beehives.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < lockers.length(); i2++) {
				if (lockers[i2].map == villamap) {
					file_delete("lockers/" + lockers[i2].id + ".locker");
					lockers.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < microwaves.length(); i2++) {
				if (microwaves[i2].map == villamap) {
					destroy_moving_sound(microwaves[i2].midsound);
					file_delete("microwaves/" + microwaves[i2].id + ".microwave");
					microwaves.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < air_conditioners.length(); i2++) {
				if (air_conditioners[i2].map == villamap) {
					destroy_moving_sound(air_conditioners[i2].mid);
					file_delete("air_conditioners/" + air_conditioners[i2].id + ".air_conditioner");
					air_conditioners.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < steams.length(); i2++) {
				if (steams[i2].map == villamap) {
					destroy_moving_sound(steams[i2].mid);
					file_delete("steams/" + steams[i2].id + ".steam");
					steams.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < fans.length(); i2++) {
				if (fans[i2].map == villamap) {
					destroy_moving_sound(fans[i2].mid);
					file_delete("fans/" + fans[i2].id + ".fan");
					fans.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < fridges.length(); i2++) {
				if (fridges[i2].map == villamap) {
					destroy_moving_sound(fridges[i2].mid);
					file_delete("fridges/" + fridges[i2].id + ".fridge");
					fridges.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < timeitems.length(); i2++) {
				if (timeitems[i2].map == villamap) {
					timeitems.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < objs.length(); i2++) {
				if (objs[i2].map.name == villamap) {
					objs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < silenceobjs.length(); i2++) {
				if (silenceobjs[i2].map.name == villamap) {
					silenceobjs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < bodyfalls.length(); i2++) {
				if (bodyfalls[i2].map == villamap) {
					bodyfalls.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < weapons.length(); i2++) {
				if (weapons[i2].map.name == villamap) {
					weapons.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < censor_bombs.length(); i2++) {
				if (censor_bombs[i2].map.name == villamap) {
					censor_bombs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < nuclear_bombs.length(); i2++) {
				if (nuclear_bombs[i2].map.name == villamap) {
					nuclear_bombs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < small_nuclear_bombs.length(); i2++) {
				if (small_nuclear_bombs[i2].map.name == villamap) {
					small_nuclear_bombs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < large_nuclear_bombs.length(); i2++) {
				if (large_nuclear_bombs[i2].map.name == villamap) {
					large_nuclear_bombs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < time_bombs.length(); i2++) {
				if (time_bombs[i2].map.name == villamap) {
					time_bombs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < grenades.length(); i2++) {
				if (grenades[i2].map.name == villamap) {
					grenades.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < canisters.length(); i2++) {
				if (canisters[i2].map.name == villamap) {
					canisters.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < snares.length(); i2++) {
				if (snares[i2].map.name == villamap) {
					snares.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < rockets.length(); i2++) {
				if (rockets[i2].map.name == villamap) {
					rockets.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < rpgs.length(); i2++) {
				if (rpgs[i2].map.name == villamap) {
					rpgs.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < turrets.length(); i2++) {
				if (turrets[i2].map.name == villamap) {
					turrets.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < mines.length(); i2++) {
				if (mines[i2].map.name == villamap) {
					mines.remove_at(i2);
					continue;
				}
			}
			for (uint i2 = 0; i2 < robots.length(); i2++) {
				if (robots[i2].map.name == villamap) {
					destroy_moving_sound(robots[i2].mid);
					robots.remove_at(i2);
					continue;
				}
			}
			file_delete("villas/" + id + ".villa");
			remove_map(villamap);
			send_reliable(0, "kills " + killmsg3(owner + "'s " + itemdeleted, hitby, get_zone_at(x, y, z, maps[get_map_index(map)])), 0);
			string hb;
			if (string_contains(hitby, "'", 1) > -1) {
				string[] parsed_data = string_split(hitby, "'", false);
				hb = parsed_data[0];
			} else
				hb = hitby;
			int index = get_player_index_from(hb);
			if (index > -1) {
				givexp(players[index], random(100, 300)*players[index].reinforcement);
				int t = is_in_team(players[index].name);
				if (t > -1) {
					int l = random(1, 100);
					teams[t].points += l;
					teams[t].transmit("This team just got " + l + " points!");
				}
			}
			villas.remove_at(i);
			return;
		}
		if (hacking == true) {
			if (hacktimer.elapsed > hacktime) {
				int h = get_player_index_from(hacker);
				if (h > -1) {
					string packet;
					if (hackmode == 1) {
						if (security_boosts >= 0) security_boosts -= random(1, 100);
						packet = "Hack successfull! The house code is " + code;
					} else {
						if (security_boosts >= 0) security_boosts -= random(1, 100);
						packet = "The hack did not complete successfully";
					}
					send_reliable(players[h], packet, 2);
					send_reliable(players[h], "startmoving", 0);
				}
				hacking = false;
			}
		}
	}
}
void spawn_villa(int x, int y, int z, string map, string owner, int code, int health, string housemap, string itemdeleted, string id) {
	villa v(x, y, z, map, owner, code, health, housemap, itemdeleted, id);
	villas.insert_last(v);
}
void load_villa(string t) {
	int x, y, z, code, health, canbell, security_boosts = 0;
	string id, map, villamap, owner, bellsound, itemdeleted;
	savedata tsd("villas/" + t + ".villa", "dl_villa");
	tsd.load();
	if (tsd.d.exists("x"))
		x = tsd.readn("x");
	if (tsd.d.exists("y"))
		y = tsd.readn("y");
	if (tsd.d.exists("z"))
		z = tsd.readn("z");
	if (tsd.d.exists("map"))
		map = tsd.read("map");
	if (tsd.d.exists("owner"))
		owner = tsd.read("owner");
	if (tsd.d.exists("code"))
		code = tsd.readn("code");
	if (tsd.d.exists("health"))
		health = tsd.readn("health");
	if (tsd.d.exists("villamap"))
		villamap = tsd.read("villamap");
	if (tsd.d.exists("id"))
		id = tsd.read("id");
	if (tsd.d.exists("security_boosts"))
		security_boosts = tsd.readn("security_boosts");
	if (tsd.d.exists("bellsound"))
		bellsound = tsd.readn("bellsound");
	if (tsd.d.exists("canbell"))
		canbell = tsd.readn("canbell");
	if (tsd.d.exists("itemdeleted"))
		itemdeleted = tsd.read("itemdeleted");
	spawn_villa(x, y, z, map, owner, code, health, villamap, itemdeleted, id);
	int hindex = get_villa_index(t);
	villas[hindex].security_boosts = security_boosts;
	villas[hindex].bellsound = bellsound;
	villas[hindex].canbell = canbell;
}
void load_all_villas() {
	string[] villafiles = find_files("villas/*.villa");
	for (uint i = 0; i < villafiles.length(); i++)
		load_villa(string_trim_right(villafiles[i], 6));
}
int get_villa_index(int x, int y, int z, mapdata@m) {
	for (uint i = 0; i < villas.length(); i++) {
		if (villas[i].map == m.name and villas[i].x == x and villas[i].y == y and villas[i].z == z)
			return i;
	}
	return -1;
}
int in_villa(player@p) {
	int index = get_player_index_from(p.name);
	if (index < 0) return -1;
	for (uint x = 0; x < villas.length(); x++) {
		if (players[index].map == villas[x].villamap) return x;
	}
	return -1;
}
int get_villa_index(string id) {
	for (uint i = 0; i < villas.length(); i++) {
		if (villas[i].id == id)
			return i;
	}
	return -1;
}
int has_villa(string who) {
	for (uint i = 0; i < villas.length(); i++) {
		int index = get_player_index_from(who);
		if (index > -1) {
			if (villas[i].owner == players[index].name or players[index].partner == villas[i].owner)
				return i;
		}
	}
	return -1;
}
